<x-app-layout>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="mb-8">
            <div class="flex items-center gap-4 mb-4">
                <a href="{{ route('books.create') }}" 
                   class="text-[#295d72] hover:text-[#3a7a94] transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Êõ∏Á±çÁôªÈå≤„Å´Êàª„Çã
                </a>
                <span class="text-gray-300">|</span>
                <a href="{{ route('books.index') }}" 
                   class="text-[#295d72] hover:text-[#3a7a94] transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2v0"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v0M8 5a2 2 0 000 4h8a2 2 0 000-4M8 5v0"></path>
                    </svg>
                    Êõ∏Á±ç‰∏ÄË¶ß
                </a>
            </div>
            <h1 class="text-3xl font-bold text-[#4f4f4f] mb-2">üìö ISBN„Çπ„Ç≠„É£„É≥</h1>
            <p class="text-gray-600">ISBN„Çí„Çπ„Ç≠„É£„É≥„Åô„Çã„Åã„ÄÅÊâãÂãï„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- ISBN„Çπ„Ç≠„É£„É≥ÈÉ®ÂàÜ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-[#4f4f4f] mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    ISBN„Çπ„Ç≠„É£„É≥
                </h2>
                
                <!-- ÊâãÂãïÂÖ•Âäõ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ISBNÊâãÂãïÂÖ•Âäõ</label>
                    <div class="flex gap-2">
                        <input type="text" id="manual-isbn" 
                               class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#295d72] focus:border-transparent"
                               placeholder="978-4-12-345678-9"
                               oninput="handleIsbnInput(this)"
                               onkeypress="handleKeyPress(event)"
                               maxlength="17">
                        <button onclick="fetchBookInfo()" 
                                class="px-4 py-2 text-white rounded-md transition-colors"
                                style="background-color: #3d7ca2;"
                                onmouseover="this.style.backgroundColor='#2a5a7a'" 
                                onmouseout="this.style.backgroundColor='#3d7ca2'">
                            Ê§úÁ¥¢
                        </button>
                    </div>
                </div>

                <!-- „Ç´„É°„É©„Çπ„Ç≠„É£„É≥ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">„Ç´„É°„É©„Åß„Çπ„Ç≠„É£„É≥</label>
                    <div id="reader" class="border border-gray-300 rounded-md" style="width: 100%; max-width: 300px;"></div>
                </div>

                <!-- ÁµêÊûúË°®Á§∫ -->
                <div id="result" class="text-sm text-gray-600"></div>
                
                <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
                <div id="loading" class="hidden text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <p class="mt-2 text-gray-600">Êõ∏Á±çÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...</p>
                </div>
            </div>

            <!-- Êõ∏Á±çÊÉÖÂ†±Ë°®Á§∫„ÉªÁ∑®ÈõÜÈÉ®ÂàÜ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-[#4f4f4f] mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    Êõ∏Á±çÊÉÖÂ†±
                </h2>
                
                <!-- „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ -->
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    <p id="error-text"></p>
                </div>

                <!-- ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏ -->
                <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                    <p id="success-text"></p>
                </div>

                <!-- Êõ∏Á±çÊÉÖÂ†±„Éï„Ç©„Éº„É† -->
                <form id="book-form" class="hidden" action="{{ route('books.store') }}" method="POST">
                    @csrf
                    
                    <!-- Ë°®Á¥ôÁîªÂÉè -->
                    <div class="mb-4 text-center">
                        <img id="book-thumbnail" src="" alt="Ë°®Á¥ôÁîªÂÉè" 
                             class="hidden mx-auto rounded-lg shadow-md max-w-32 max-h-48">
                        <p id="no-image" class="text-gray-500 text-sm">Ë°®Á¥ôÁîªÂÉè„Å™„Åó</p>
                    </div>

                    <!-- Âü∫Êú¨ÊÉÖÂ†± -->
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">„Çø„Ç§„Éà„É´ *</label>
                            <input type="text" name="title" id="title" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#295d72] focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ËëóËÄÖ *</label>
                            <input type="text" name="author" id="author" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#295d72] focus:border-transparent">
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ISBN *</label>
                            <input type="text" name="isbn" id="isbn" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#295d72] focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Âá∫ÁâàÁ§æ</label>
                            <input type="text" name="publisher" id="publisher"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#295d72] focus:border-transparent">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Âá∫ÁâàÊó•</label>
                        <input type="date" name="published_date" id="published_date"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#295d72] focus:border-transparent">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë™¨Êòé</label>
                        <textarea name="description" id="description" rows="4"
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#295d72] focus:border-transparent"></textarea>
                    </div>

                    <!-- Èö†„Åó„Éï„Ç£„Éº„É´„Éâ -->
                    <input type="hidden" name="thumbnail_url" id="thumbnail_url">

                    <!-- ÁôªÈå≤„Éú„Çø„É≥ -->
                    <div class="flex gap-3">
                        <button type="submit" 
                                class="flex-1 px-4 py-3 text-white rounded-md transition-colors font-medium"
                                style="background-color: #3d7ca2;"
                                onmouseover="this.style.backgroundColor='#2a5a7a'" 
                                onmouseout="this.style.backgroundColor='#3d7ca2'">
                            üìö Êõ∏Á±ç„ÇíÁôªÈå≤
                        </button>
                        <button type="button" onclick="resetForm()" 
                                class="px-4 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
                            „É™„Çª„ÉÉ„Éà
                        </button>
                    </div>
                </form>

                <!-- ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏ -->
                <div id="initial-message" class="text-center text-gray-500 py-8">
                    <p>üì± ISBN„Çí„Çπ„Ç≠„É£„É≥„Åæ„Åü„ÅØÂÖ•Âäõ„Åô„Çã„Å®„ÄÅÊõ∏Á±çÊÉÖÂ†±„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let html5QrcodeScanner = null;

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Ç´„É°„É©„ÇíÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeCamera();
        });

        function initializeCamera() {
            try {
                html5QrcodeScanner = new Html5Qrcode("reader");
                html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: 250 },
                    onScanSuccess,
                    onScanError
                );
            } catch (error) {
                console.error("„Ç´„É°„É©„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó:", error);
                document.getElementById('result').innerHTML = '<p class="text-red-500">„Ç´„É°„É©„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
            }
        }

        function onScanSuccess(decodedText) {
            // ISBN„ÅÆÂü∫Êú¨„ÉÅ„Çß„ÉÉ„ÇØ
            if (!decodedText.startsWith('978') && !decodedText.startsWith('979')) {
                showError("„Åì„Çå„ÅØISBN„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì: " + decodedText);
                return;
            }

            document.getElementById('result').innerHTML = '<p class="text-green-600">‚úÖ ISBNÊ§úÂá∫: ' + decodedText + '</p>';
            document.getElementById('manual-isbn').value = decodedText;
            
            // Êõ∏Á±çÊÉÖÂ†±„ÇíÂèñÂæó
            fetchBookInfoByIsbn(decodedText);
        }

        function onScanError(errorMessage) {
            // „Çπ„Ç≠„É£„É≥„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºàÈÄ£Á∂ö„Çπ„Ç≠„É£„É≥‰∏≠„ÅÆÊ≠£Â∏∏„Å™Âãï‰ΩúÔºâ
        }

        // „Éá„Éê„Ç¶„É≥„ÇπÁî®„ÅÆ„Çø„Ç§„Éû„Éº
        let searchTimeout = null;

        function fetchBookInfo() {
            const isbn = document.getElementById('manual-isbn').value.trim();
            if (!isbn) {
                showError("ISBN„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                return;
            }
            fetchBookInfoByIsbn(isbn);
        }

        // „Éá„Éê„Ç¶„É≥„Çπ‰ªò„Åç„ÅÆÊ§úÁ¥¢Èñ¢Êï∞
        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const isbn = document.getElementById('manual-isbn').value.trim();
                if (isbn && isbn.length >= 10) {
                    fetchBookInfoByIsbn(isbn);
                }
            }, 1000); // 1ÁßíÂæÖÊ©ü
        }

        // ISBNËá™Âãï„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatIsbn(input) {
            // Êï∞Â≠ó„Å®X„ÅÆ„Åø„ÇíÊäΩÂá∫
            let cleaned = input.replace(/[^0-9X]/g, '');
            
            // ISBN-13„ÅÆÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            if (cleaned.length >= 3) {
                if (cleaned.startsWith('978') || cleaned.startsWith('979')) {
                    // 978-4-12-345678-9 „ÅÆÂΩ¢Âºè
                    return cleaned.replace(/(\d{3})(\d{1})(\d{2})(\d{6})(\d{1})/, '$1-$2-$3-$4-$5');
                }
            }
            
            // ISBN-10„ÅÆÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            if (cleaned.length === 10) {
                // 4-12-345678-9 „ÅÆÂΩ¢Âºè
                return cleaned.replace(/(\d{1})(\d{2})(\d{6})(\d{1})/, '$1-$2-$3-$4');
            }
            
            return cleaned;
        }

        function fetchBookInfoByIsbn(isbn) {
            showLoading(true);
            hideAllMessages();

            fetch('/isbn-fetch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ isbn: isbn })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                
                if (data.success && data.data) {
                    displayBookInfo(data.data);
                } else {
                    const detailedError = getDetailedErrorMessage(data.error || "Êõ∏Á±çÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", isbn);
                    showError(detailedError);
                    // „Ç®„É©„Éº„Åß„ÇÇÊâãÂãïÂÖ•Âäõ„Éï„Ç©„Éº„É†„ÅØË°®Á§∫
                    showBookForm();
                    document.getElementById('isbn').value = isbn;
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error:', error);
                const detailedError = getDetailedErrorMessage("ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü", isbn);
                showError(detailedError);
                // „Ç®„É©„Éº„Åß„ÇÇÊâãÂãïÂÖ•Âäõ„Éï„Ç©„Éº„É†„ÅØË°®Á§∫
                showBookForm();
                document.getElementById('isbn').value = isbn;
            });
        }

        function displayBookInfo(bookData) {
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            showSuccess(`üìö Êõ∏Á±çÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü: „Äå${bookData.title}„Äç`);
            
            // „Éï„Ç©„Éº„É†„Å´ÊÉÖÂ†±„ÇíË®≠ÂÆö
            document.getElementById('title').value = bookData.title || '';
            document.getElementById('author').value = bookData.author || '';
            document.getElementById('isbn').value = bookData.isbn || document.getElementById('manual-isbn').value;
            document.getElementById('publisher').value = bookData.publisher || '';
            document.getElementById('published_date').value = bookData.published_date || '';
            document.getElementById('description').value = bookData.description || '';
            document.getElementById('thumbnail_url').value = bookData.thumbnail_url || '';

            // Ë°®Á¥ôÁîªÂÉè„ÅÆË°®Á§∫
            const thumbnail = document.getElementById('book-thumbnail');
            const noImage = document.getElementById('no-image');
            
            if (bookData.thumbnail_url) {
                thumbnail.src = bookData.thumbnail_url;
                thumbnail.classList.remove('hidden');
                noImage.classList.add('hidden');
            } else {
                thumbnail.classList.add('hidden');
                noImage.classList.remove('hidden');
            }

            showBookForm();
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            const successText = document.getElementById('success-text');
            successText.textContent = message;
            successDiv.classList.remove('hidden');
            
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËá™Âãï„ÅßÈö†„ÅôÔºà5ÁßíÂæåÔºâ
            setTimeout(() => {
                hideSuccess();
            }, 5000);
        }

        function hideSuccess() {
            document.getElementById('success-message').classList.add('hidden');
        }

        function showBookForm() {
            document.getElementById('initial-message').style.display = 'none';
            document.getElementById('book-form').classList.remove('hidden');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.innerHTML = message; // textContent „Åã„Çâ innerHTML „Å´Â§âÊõ¥ÔºàHTML„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅÔºâ
            errorDiv.classList.remove('hidden');
            
            // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËá™Âãï„ÅßÈö†„ÅôÔºà10ÁßíÂæåÔºâ
            setTimeout(() => {
                hideError();
            }, 10000);
        }

        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        function hideAllMessages() {
            hideError();
            hideSuccess();
        }

        // ISBNÂÖ•ÂäõÊôÇ„ÅÆÂá¶ÁêÜ
        function handleIsbnInput(input) {
            // Ëá™Âãï„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            const formatted = formatIsbn(input.value);
            if (formatted !== input.value) {
                input.value = formatted;
            }
            
            // „Éá„Éê„Ç¶„É≥„ÇπÊ§úÁ¥¢
            debouncedSearch();
        }

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                fetchBookInfo();
            }
        }

        // „Çà„ÇäË©≥Á¥∞„Å™„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
        function getDetailedErrorMessage(error, isbn) {
            if (error.includes('404') || error.includes('Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì')) {
                return `ISBN„Äå${isbn}„Äç„ÅÆÊõ∏Á±çÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ‰ª•‰∏ã„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑÔºö
                        <ul class="mt-2 ml-4 list-disc text-sm">
                            <li>ISBN„ÅåÊ≠£„Åó„ÅèÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çã„Åã</li>
                            <li>„Éè„Ç§„Éï„É≥„ÅÆ‰ΩçÁΩÆ„ÅåÊ≠£„Åó„ÅÑ„Åã</li>
                            <li>Âè§„ÅÑÊõ∏Á±ç„ÅÆÂ†¥Âêà„ÄÅ„Éá„Éº„Çø„Éô„Éº„Çπ„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô</li>
                        </ul>`;
            }
            
            if (error.includes('ÈÄö‰ø°„Ç®„É©„Éº')) {
                return `ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ‰ª•‰∏ã„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑÔºö
                        <ul class="mt-2 ml-4 list-disc text-sm">
                            <li>„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                            <li>„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ</li>
                            <li>ÂïèÈ°å„ÅåÁ∂ö„ÅèÂ†¥Âêà„ÅØÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ</li>
                        </ul>`;
            }
            
            return error;
        }

        function resetForm() {
            // „Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
            clearTimeout(searchTimeout);
            
            document.getElementById('book-form').reset();
            document.getElementById('book-thumbnail').classList.add('hidden');
            document.getElementById('no-image').classList.remove('hidden');
            document.getElementById('manual-isbn').value = '';
            document.getElementById('result').innerHTML = '';
            hideError();
            
            // „Éï„Ç©„Éº„É†„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            document.getElementById('book-form').classList.add('hidden');
            document.getElementById('initial-message').style.display = 'block';
        }
    </script>
</x-app-layout>
