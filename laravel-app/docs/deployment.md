# デプロイ構成ガイド

## 構成概要

| 役割 | サービス | 費用 |
|---|---|---|
| アプリケーション（Laravel） | Render（Web Service） | 無料 |
| データベース（PostgreSQL） | Neon | 無料 |

**合計費用: 0円**（無料枠の範囲内）

---

## Render（アプリケーションサーバー）

### Renderとは
- Webアプリを簡単にデプロイできるクラウドサービス
- GitHubにコードをpushするだけで自動デプロイされる
- サーバーの構築・管理が不要
- HTTPS（SSL）が自動で付く

### 無料プランの仕様
| 項目 | 内容 |
|---|---|
| URL | `アプリ名.onrender.com`（自動発行） |
| HTTPS | 自動（設定不要） |
| デプロイ | GitHubにpushすると自動 |
| スリープ | 15分アクセスなしで休止 → 次のアクセスで自動復帰（約30秒） |
| 独自ドメイン | 設定可能（任意） |

### スリープについて
- 15分間誰もアクセスしないと、サーバーが省電力モードに入る
- 次に誰かがアクセスすると**自動で起動**する（管理者の操作は不要）
- 起動に約30秒かかるため、最初のアクセスだけ少し待つ
- 一度起きた後は通常速度で動作する
- 有料プラン（$7/月）にするとスリープしなくなる

---

## Neon（データベース）

### Neonとは
- 無料で使えるPostgreSQLデータベースサービス
- Renderの無料DB（90日期限あり）と違い、**無期限で無料**

### 無料プランの仕様
| 項目 | 内容 |
|---|---|
| 容量 | 0.5GB（500MB） |
| 期限 | なし（無期限） |
| バックアップ | 7日間の履歴保持 |
| 接続 | SSL暗号化通信 |

### 500MBで足りるのか
- 書籍1冊のデータ: 約0.5KB
- 貸出記録1件: 約0.1KB
- **約10万冊 + 100万件の貸出記録**が保存可能
- 学校図書の規模であれば十分

---

## デプロイ手順

### 1. Neon（DB）のセットアップ
1. [neon.tech](https://neon.tech) でアカウント作成
2. 「New Project」でプロジェクトを作成
3. 接続文字列をコピー（後で使う）
   ```
   postgresql://ユーザー名:パスワード@ep-xxxxx.region.neon.tech/データベース名?sslmode=require
   ```

### 2. Render（アプリ）のセットアップ
1. [render.com](https://render.com) でアカウント作成
2. 「New Web Service」→ GitHubリポジトリを接続
3. 設定:
   - **Runtime**: Docker（Dockerfileを使用）
   - **Instance Type**: Free
4. 環境変数を設定（後述）

### 3. 環境変数の設定（Renderの管理画面で設定）

| 変数名 | 値 | 説明 |
|---|---|---|
| `APP_NAME` | `図書管理システム` | アプリ名 |
| `APP_ENV` | `production` | 本番環境 |
| `APP_DEBUG` | `false` | デバッグ無効 |
| `APP_KEY` | `php artisan key:generate`で生成 | 暗号化キー |
| `APP_URL` | `https://アプリ名.onrender.com` | アプリのURL |
| `DB_CONNECTION` | `pgsql` | PostgreSQL |
| `DB_HOST` | `ep-xxxxx.region.neon.tech` | Neonのホスト |
| `DB_PORT` | `5432` | ポート |
| `DB_DATABASE` | Neonで作成したDB名 | DB名 |
| `DB_USERNAME` | Neonのユーザー名 | ユーザー |
| `DB_PASSWORD` | Neonのパスワード | パスワード |
| `DB_SSLMODE` | `require` | SSL必須 |

---

## 運用について

### 更新方法
```
GitHubにpush → 自動でデプロイ（数分で反映）
```

### データのバックアップ
- Neon無料プランで7日間の自動バックアップあり
- 手動バックアップが必要な場合は `pg_dump` コマンドを使用

### 延滞チェック（自動処理）
- Renderの有料プランではCron Jobが使える
- 無料プランでは外部サービス（cron-job.org等）から定期的にアクセスして実行する方法がある

### 費用が発生するケース
| 状況 | 対応 | 費用 |
|---|---|---|
| スリープが困る | Render有料プラン | $7/月 |
| DB容量が500MBを超える | Neon有料プラン | $19/月 |
| 独自ドメインを使う | ドメイン取得 | 年1,000円程度 |

現在の学校図書アプリの規模であれば、**すべて無料枠で運用可能**。

---

## セキュリティ対策（実施済み）
- HTTPS通信（Render自動）
- 書籍登録・貸出管理は管理者のみ
- ISBN検索APIは認証必須
- 検索入力のサニタイズ（SQLインジェクション対策）
- `APP_DEBUG=false`（エラー詳細を非表示）
