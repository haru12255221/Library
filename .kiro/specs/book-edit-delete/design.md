# 書籍編集・削除機能 設計書

## 概要

図書館管理システムに管理者向けの書籍編集・削除機能を追加します。この機能は管理者の書籍管理ページ（一覧）から操作でき、適切な権限管理とデータ整合性を保ちながら実装されます。

## 操作フロー

### 詳細表示フロー
```
書籍管理一覧ページ → [書籍情報をクリック] → 書籍詳細ページ → [戻る] → 書籍管理一覧ページ
```

### 編集フロー
```
書籍管理一覧ページ → [編集ボタン] → 書籍編集ページ → [更新] → 書籍管理一覧ページ
                                      ↓
                                   [キャンセル] → 書籍管理一覧ページ
```

### 削除フロー
```
書籍管理一覧ページ → [削除ボタン] → 確認ダイアログ → [OK] → 書籍管理一覧ページ
                                      ↓
                                   [キャンセル] → 書籍管理一覧ページ（操作なし）
```

### フロー詳細
- **編集完了後**: 書籍管理一覧ページにリダイレクト（成功メッセージ表示）
- **削除完了後**: 書籍管理一覧ページにリダイレクト（成功メッセージ表示）
- **エラー時**: 各ページでエラーメッセージ表示、ユーザーは操作を再試行可能

## アーキテクチャ

### システム構成
```
[管理者UI] → [BookController] → [Book Model] → [Database]
     ↓              ↓
[AdminMiddleware] [Validation]
```

### セキュリティ層
1. **認証層**: Laravel標準認証システム
2. **認可層**: AdminMiddleware（管理者権限チェック）
3. **データ層**: Eloquent ORM（SQLインジェクション対策）
4. **UI層**: Blade（XSS対策）

## コンポーネントと インターフェース

### 1. BookController（拡張）

既存のBookControllerに以下のメソッドを追加：

#### edit(Book $book)
- **目的**: 書籍編集フォームの表示
- **権限**: 管理者のみ（adminミドルウェア）
- **戻り値**: books.edit ビュー

#### update(Request $request, Book $book)
- **目的**: 書籍情報の更新処理
- **権限**: 管理者のみ（adminミドルウェア）
- **バリデーション**:
  - title: 必須、最大255文字
  - author: 必須、最大255文字
  - isbn: 必須、正規表現チェック、重複チェック（編集中の書籍を除く）
  - publisher: 任意、最大255文字
  - published_date: 任意、日付形式、今日以前
  - description: 任意、最大2000文字
  - thumbnail_url: 任意、URL形式
- **戻り値**: 書籍管理一覧ページへリダイレクト（成功メッセージ付き）

#### destroy(Book $book)
- **目的**: 書籍の削除処理
- **権限**: 管理者のみ（adminミドルウェア）
- **制約**: 貸出中の書籍は削除不可
- **戻り値**: 書籍管理ページへリダイレクト（成功メッセージ付き）

### 2. ルート設計

現在のルート構成を整理し、管理者専用ルートを統一します：

```php
// 管理者専用ルート（統一）
Route::middleware(['auth', 'admin'])->prefix('admin')->name('admin.')->group(function () {
    // 書籍管理
    Route::get('/books', [\App\Http\Controllers\Admin\BookController::class, 'index'])->name('books.index');
    Route::get('/books/create', [BookController::class, 'create'])->name('books.create');
    Route::post('/books', [BookController::class, 'store'])->name('books.store');
    Route::get('/books/{book}/edit', [BookController::class, 'edit'])->name('books.edit');
    Route::put('/books/{book}', [BookController::class, 'update'])->name('books.update');
    Route::delete('/books/{book}', [BookController::class, 'destroy'])->name('books.destroy');
    
    // 貸出管理
    Route::get('/loans', [LoanController::class, 'index'])->name('loans.index');
});
```

**ルート整理の方針**:
- 管理者機能は全て `/admin` プレフィックス配下に統一
- 一般ユーザー向けと管理者向けを明確に分離
- 重複したルート定義を整理

### 3. ビュー設計

#### admin/books/index.blade.php（簡素化）

**現在の問題点**: 情報が多すぎて管理者の操作効率が悪い

**改善案**: テーブル構成をシンプルに変更
```
| 書籍情報 | 貸出状況 | 操作 |
```

**具体的なレイアウト例**:
```
| [クリッカブル領域]         | 利用可能     | [✏️] [🗑️]     |
| [表紙画像] タイトル        |             |                |
|           著者名          |             |                |
|           ISBN: 978-xxx   |             |                |
```

**UI詳細**:
- 書籍情報列全体に `cursor: pointer` を適用
- ホバー時に背景色を薄いグレーに変更
- クリック時に書籍詳細ページ（`books.show`）に遷移

### 一般ユーザー書籍一覧ページの統一

**現在の問題**: 管理者ページと一般ユーザーページでクリック動作が異なる

**改善案**: 一般ユーザー向け書籍一覧ページ（`books/index.blade.php`）も同様にカード全体をクリッカブルに変更
- 現在: タイトルリンクのみクリッカブル
- 変更後: カード全体をクリッカブルに統一
- 同じホバー効果とカーソル変更を適用

**メリット**:
- UI/UXの統一性向上
- クリック可能領域の拡大によるユーザビリティ向上
- 管理者と一般ユーザーで同じ操作感

**列の詳細**:
- **書籍情報列**: 
  - 表紙画像（小）
  - タイトル + 著者（縦並び）
  - ISBN（小さく表示）
- **貸出状況列**: 
  - 利用可能/貸出中のステータスのみ
  - 貸出中の場合は返却予定日も表示
- **操作列**:
  - 編集ボタン（編集アイコン、ツールチップ「編集」）
  - 削除ボタン（削除アイコン、ツールチップ「削除」、貸出中は無効化）

**インタラクション設計**:
- **書籍情報列全体**: クリッカブル、書籍詳細ページへのリンク
- **ホバー効果**: 書籍情報列にマウスオーバー時の視覚的フィードバック
- **カーソル**: 書籍情報列では pointer カーソル表示

**削除する情報**:
- 出版情報列（出版社、出版日）→ 編集ページで確認可能
- 詳細なISBN表示 → 書籍情報列に小さく統合

**メリット**:
- 画面の横幅を削減
- 重要な情報（タイトル、著者、貸出状況、操作）に集中
- モバイル対応が向上

**代替案: カード形式レイアウト**
テーブルではなく、カード形式での表示も検討可能：
```
[クリッカブルカード領域]              [編集] [削除]
[表紙] タイトル                      [ステータス]
      著者名                      
      ISBN: xxx-xxx-xxx
```

**どちらのレイアウトを採用しますか？**
1. **シンプルテーブル**: 情報密度が高く、一覧性に優れる
2. **カード形式**: 視覚的に分かりやすく、モバイルフレンドリー

#### books/edit.blade.php（新規作成）
- **レイアウト**: 既存のbooks.createと統一
- **フォーム要素**:
  - タイトル（必須）
  - 著者（必須）
  - ISBN（必須、重複チェック）
  - 出版社（任意）
  - 出版日（任意）
  - 概要（任意、テキストエリア）
  - 表紙画像URL（任意）
- **プレビュー**: 現在の表紙画像表示
- **ボタン**: キャンセル、更新

## データモデル

### Book Model（既存）
既存のBookモデルを活用。追加の変更は不要。

**重要なメソッド**:
- `isAvailable()`: 削除可能性の判定に使用
- `currentLoan`: 貸出状況の確認に使用

## エラーハンドリング

### バリデーションエラー
- **表示方法**: フォーム上部にアラートコンポーネント
- **内容**: 具体的なエラーメッセージ
- **復旧**: 入力値の保持（old()関数）

### 権限エラー
- **401 Unauthorized**: 未認証ユーザー
- **403 Forbidden**: 一般ユーザー
- **処理**: AdminMiddlewareで自動処理

### 削除制約エラー
- **条件**: 貸出中書籍の削除試行
- **表示**: エラーメッセージでリダイレクト
- **UI**: 削除ボタンの無効化で事前防止

### データベースエラー
- **重複エラー**: ISBN重複時のバリデーションエラー
- **制約エラー**: 外部キー制約違反時の適切なメッセージ

## テスト戦略

### 機能テスト
1. **編集機能**:
   - 正常な編集処理
   - バリデーションエラー処理
   - 権限チェック
   - ISBN重複チェック

2. **削除機能**:
   - 正常な削除処理
   - 貸出中書籍の削除防止
   - 権限チェック
   - 確認ダイアログの動作

3. **UI/UX**:
   - レスポンシブデザイン
   - ボタンの状態管理
   - メッセージ表示

### セキュリティテスト
1. **権限テスト**:
   - 未認証ユーザーのアクセス
   - 一般ユーザーのアクセス
   - 管理者の正常アクセス

2. **データ整合性テスト**:
   - 不正なデータ送信
   - CSRFトークンの検証
   - SQLインジェクション対策

## パフォーマンス考慮事項

### データベースクエリ最適化
- **Eager Loading**: 書籍一覧での貸出状況取得時に`with('currentLoan')`を使用
- **インデックス**: ISBN列のユニークインデックス活用

### UI最適化
- **画像読み込み**: 表紙画像の遅延読み込み
- **JavaScript**: 削除確認ダイアログの軽量実装

## セキュリティ対策

### 認証・認可
- **多層防御**: ミドルウェア + コントローラーレベルでの権限チェック
- **セッション管理**: Laravel標準のセッション管理

### データ保護
- **CSRF対策**: 全フォームでCSRFトークン必須
- **XSS対策**: Bladeテンプレートの自動エスケープ
- **SQLインジェクション対策**: Eloquent ORMの使用

### ログ記録
- **操作ログ**: 編集・削除操作の記録
- **エラーログ**: 権限エラーや制約違反の記録